' Gambas class file

Public Sub Form_Open()

  timerTest.Delay = 100
  timerTest.Enabled = True

End Sub

Public Sub timerTest_Timer()

  Dim k As Integer, s As String, ret As String
  Dim fichier As String, sGrep As String, sValue As String, cl As String

  timerTest.Enabled = False

  ' # modifier /etc/hosts.allow

  cl = comboListMachine.Text

  Message("debug L avec /etc/hosts.allow + IP client")
  fichier = "/tmp/hosts.allow"
  cl = "192.168.1.111"

  ' check file exist
  If Exist(fichier) = False Then
    s = "# Allow this client\nportmap:" & cl & "\nnfsd:" & cl & "\nmountd:" & cl & "\nlockd:" & cl & "\nrquotad:" & cl & "\nstatd:" & cl
    s = "sudo echo " & Chr(34) & s & Chr(34) & " >> " & fichier
    Shell s Wait
  Else
    '
    ' grep value from hosts.allow
    '
    For k = 1 To 6

      Select Case k
        Case 1
          sValue = "portmap:"
        Case 2
          sValue = "nfsd:"
        Case 3
          sValue = "mountd:"
        Case 4
          sValue = "lockd:"
        Case 5
          sValue = "rquotad:"
        Case 6
          sValue = "statd:"
      End Select

      sGrep = "cat " & fichier & " | grep '" & sValue & "'"

      Shell sGrep Wait To ret

      ' delete the \n character at the end
      If Mid(ret, InStr(ret, "\n")) Then ret = Mid(ret, 1, InStr(ret, "\n") - 1)

      If ret = "" Then
        ' add the line
        s = "sudo echo " & Chr(34) & sValue & cl & Chr(34) & " >> " & fichier
        Shell s Wait

      Else If Mid(ret, InStr(ret, ":") + 1) <> cl Then
        ' change value
        s = "sudo sed -i -e 's/" & ret & "/" & sValue & cl & "/g' " & fichier
        Shell s Wait

      Endif

    Next

  Endif

  Me.Close

End
